<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
        integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-3w3c2M1GyvwhTWeEdz6pHgmsavfVzca6xWoT/ZVnDXeQUq2KKZKM+d+4Uws/zlYFm3nILHRaEtbUJwXbpYpWhQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="../css/style.css" />

    <link rel="icon" type="image/png" href="../images/cnsclogo.png" />
    <title>Bitscon - Admin</title>
</head>

<body>

    <!-- Header -->
    <div class="container-fluid header_tab">
        <div class="row">
            <div class="col-md-3 text-center">
                <img src="../images/cnsclogo.png" width="90px" height="85px" />
            </div>

            <div class="col-md-6 text-center">
                <span style="line-height: 1.5">
                    <h4 style="margin-bottom: 0; margin-top: 10px">
                        BITSCON 2024 ATTENDANCE TRACKING FORM
                    </h4>
                    <p style="margin-top: 0">
                        Camarines Norte State College<br />April 23-26, 2024
                    </p>
                </span>
            </div>

            <div class="col-md-3 text-center">
                <img src="../images/cnsclogo.png" width="90px" height="85px" />
            </div>
        </div>
    </div>
    <br />

    <!-- Table -->
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="schoolInput">School:</label>
                    <select class="form-control" id="schoolInput" name="schoolInput">
                        <option value="SELECT_ALL">All</option>
                        <option value="Camarines Norte State College">Camarines Norte State College</option>
                        <option value="Our Lady of Lourdes">Our Lady of Lourdes</option>
                        <option value="Mabini Colleges">Mabini Colleges</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4">
                <div class="form-group">
                    <label for="schoolInput">Date:</label>
                    <select class="form-control" id="dateInput" name="dateInput">
                        <option value="SELECT_ALL">All</option>
                        <!--This will be populated dynamically-->
                    </select>
                </div>
            </div>

            <div class="col-md-4 text-right">
                <br />
                <!-- <a
            href="#"
            class="btn btn-primary"
            role="button"
            style="margin-top: 10px"
            id="searchBtn"
            name="searchBtn"
          >
            <i class="fas fa-search"></i> Search
          </a> -->
            </div>
        </div>
    </div>
    <br />

    <div class="container container_menu">

        <div class="table-responsive-lg">
            <table class="table table-hover  table-custom" id="attendanceTable">
                <thead>
                    <tr>
                        <th scope="col">Attendee ID</th>
                        <th scope="col">Name</th>
                        <th scope="col">Mobile Number</th>
                        <th scope="col">School</th>
                        <th scope="col">Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!--This will be populated dynamically-->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
        crossorigin="anonymous"></script>
    <script>
        async function populateDateOptions() {
            try {
                const response = await fetch("http://localhost:8090/api/admin/attendance/view/dates", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                const dateSelect = document.getElementById('dateInput');
                data.forEach(item => {
                    const date = new Date(item.date);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0'); // Month is zero-based, so we add 1
                    const day = String(date.getDate()).padStart(2, '0');
                    const formattedDateValue = `${year}-${month}-${day}`;
                    const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const option = document.createElement('option');
                    option.value = formattedDateValue;
                    option.textContent = formattedDate;

                    // Append the option to the select element
                    dateSelect.appendChild(option);
                });

            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }

        async function populateTable() {
            try {
                const response = await fetch("http://localhost:8090/api/admin/attendance/view/all", {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                const tableBody = document.querySelector('#attendanceTable tbody');

                // Clear existing table rows
                tableBody.innerHTML = '';

                // Populate table with data
                data.forEach(record => {
                    record.dateId.forEach(date => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
            <td>${record.attendeeID}</td>
            <td>${record.fname} ${record.minitial} ${record.lname}</td>
            <td>+63 ${record.number}</td>
            <td>${record.school}</td>
            <td>${new Date(date.date).toLocaleDateString()}</td>
          `;
                        tableBody.appendChild(row);
                    });
                });

            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }

        async function updateTable() {

            const selectedDate = document.getElementById('dateInput').value;
            const selectedSchool = document.getElementById('schoolInput').value;

            const requestBody = {
                "school": selectedSchool,
                "date": selectedDate
            };

            try {
                const response = await fetch("http://localhost:8090/api/admin/attendance/view/filtered", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();

                const tableBody = document.querySelector('#attendanceTable tbody');

                // Clear existing table rows
                tableBody.innerHTML = '';

                // Populate table with data
                data.forEach(record => {
                    record.dateId.forEach(date => {

                        const tempDate = new Date(date.date);
                        const year = tempDate.getFullYear();
                        const month = String(tempDate.getMonth() + 1).padStart(2, '0'); // Month is zero-based, so we add 1
                        const day = String(tempDate.getDate()).padStart(2, '0');
                        const formattedDateValue = `${year}-${month}-${day}`;
                        if (formattedDateValue == selectedDate) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
            <td>${record.attendeeID}</td>
            <td>${record.fname} ${record.minitial} ${record.lname}</td>
            <td>+63 ${record.number}</td>
            <td>${record.school}</td>
            <td>${new Date(date.date).toLocaleDateString()}</td>
          `;
                            tableBody.appendChild(row);
                        } else if (selectedDate == "SELECT_ALL") {
                            const row = document.createElement('tr');
                            row.innerHTML = `
            <td>${record.attendeeID}</td>
            <td>${record.fname} ${record.minitial} ${record.lname}</td>
            <td>+63 ${record.number}</td>
            <td>${record.school}</td>
            <td>${new Date(date.date).toLocaleDateString()}</td>
          `;
                            tableBody.appendChild(row);
                        }
                    });
                });

            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }

        // Call the function to update table data when the filters change
        $("#dateInput").change(updateTable);
        $("#schoolInput").change(updateTable);

        // Call the function to populate initial table data when the page loads
        document.addEventListener('DOMContentLoaded', populateTable);
        document.addEventListener('DOMContentLoaded', populateDateOptions);
    </script>
</body>

</html>